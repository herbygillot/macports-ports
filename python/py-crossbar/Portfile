# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           python 1.0

name                py-crossbar
version             20.8.1
revision            0
categories          python net
platforms           darwin
license             AGPL-3

homepage            https://crossbar.io

description         Multi protocol WAMP/WebSocket REST/HTTP MQTT application \
                    router for microservices.
long_description    {*}${description}

maintainers         {gmail.com:herby.gillot @herbygillot} \
                    openmaintainer

checksums           rmd160  c52ae7e750d1ea397c6133d6973d39360d7d7511 \
                    sha256  c0e7a25c12fd768e8cc9be3f572d0f7399b43089b0396635f2ab609fa2855572 \
                    size    382515

python.versions     38

if {${subport} ni "${name} crossbar"} {

    # Patches:
    #
    #   patch-requirements-min.txt.diff:
    #       remove maximum version limit for idna and urllib3
    #
    #   patch-setup.py.diff:
    #       avoid installing LICENSE files into the Python site-packages root
    #
    patchfiles      patch-requirements-min.txt.diff \
                    patch-setup.py.diff

    depends_build-append \
                    port:py${python.version}-setuptools

    depends_lib-append \
                    port:py${python.version}-attrs \
                    port:py${python.version}-autobahn \
                    port:py${python.version}-bcrypt \
                    port:py${python.version}-bitstring \
                    port:py${python.version}-cbor \
                    port:py${python.version}-click \
                    port:py${python.version}-constantly \
                    port:py${python.version}-cryptography \
                    port:py${python.version}-h2 \
                    port:py${python.version}-idna \
                    port:py${python.version}-incremental \
                    port:py${python.version}-jinja2 \
                    port:py${python.version}-lmdb \
                    port:py${python.version}-mistune \
                    port:py${python.version}-netaddr \
                    port:py${python.version}-passlib \
                    port:py${python.version}-priority \
                    port:py${python.version}-psutil \
                    port:py${python.version}-pyubjson \
                    port:py${python.version}-asn1 \
                    port:py${python.version}-asn1-modules \
                    port:py${python.version}-pygments \
                    port:py${python.version}-pynacl \
                    port:py${python.version}-openssl \
                    port:py${python.version}-pyqrcode \
                    port:py${python.version}-pytrie \
                    port:py${python.version}-yaml \
                    port:py${python.version}-sdnotify \
                    port:py${python.version}-service_identity \
                    port:py${python.version}-setproctitle \
                    port:py${python.version}-setuptools \
                    port:py${python.version}-treq \
                    port:py${python.version}-txaio \
                    port:py${python.version}-txtorcon \
                    port:py${python.version}-u-msgpack-python \
                    port:py${python.version}-urllib3 \
                    port:py${python.version}-watchdog \
                    port:py${python.version}-werkzeug \
                    port:py${python.version}-zlmdb \
                    port:py${python.version}-zopeinterface
}

subport crossbar {
    name                crossbar

    revision            0
    categories          net

    description         Run the crossbar.io WAMP application router as a \
                        service.
    long_description    {*}${description}

    depends_build
    depends_lib         port:py38-crossbar

    set cb_config_path  ${prefix}/etc/${name}
    set cb_data_path    ${prefix}/var/db/${name}
    set cb_log_path     ${prefix}/var/log/${name}
    set cb_share_path   ${prefix}/share/${name}

    set cb_plist_path   ${prefix}/etc/LaunchDaemons/org.macports.${name}

    set cb_config_file  ${cb_config_path}/config.json
    set cb_config_src   ${cb_share_path}/config.json.example
    set cb_log_file     ${cb_log_path}/crossbar.log

    set cb_plist        org.macports.${name}.plist

    set cb_bin          ${prefix}/bin/crossbar-3.8

    set cb_user         _crossbar

    add_users           ${cb_user} \
                        group=${cb_user} \
                        realname=Crossbar.io

    distfiles

    build {}

    extract {
        copy ${filespath}/${cb_plist} ${workpath}/
    }

    patch {
        set cb_plist_template ${workpath}/${cb_plist}

        reinplace "s|@NAME@|${name}|g"                  ${cb_plist_template}
        reinplace "s|@USER@|${cb_user}|g"               ${cb_plist_template}
        reinplace "s|@GROUP@|${cb_user}|g"              ${cb_plist_template}
        reinplace "s|@DATADIR@|${cb_data_path}|g"       ${cb_plist_template}
        reinplace "s|@BIN@|${cb_bin}|g"                 ${cb_plist_template}
        reinplace "s|@CONF_FILE@|${cb_config_file}|g"   ${cb_plist_template}
        reinplace "s|@LOGFILE@|${cb_log_file}|g"        ${cb_plist_template}
    }

    destroot.keepdirs-append \
                        ${destroot}/${cb_config_path} \
                        ${destroot}/${cb_data_path} \
                        ${destroot}/${cb_log_path}

    destroot {
        xinstall -d -m 755                  ${destroot}${cb_config_path}
        xinstall -d -m 755 -o ${cb_user}    ${destroot}${cb_data_path}
        xinstall -d -m 755                  ${destroot}${cb_log_path}
        xinstall -d -m 755                  ${destroot}${cb_share_path}

        copy ${filespath}/config.json.example ${destroot}${cb_share_path}/

        xinstall -d -m 755 ${destroot}${cb_plist_path}

        xinstall -m 0644 -o root -W ${workpath} ${cb_plist} \
            ${destroot}${cb_plist_path}

        xinstall -d -m 755 ${destroot}/Library/LaunchDaemons

        ln -s ${cb_plist_path}/${cb_plist} \
            ${destroot}/Library/LaunchDaemons/${cb_plist}
    }

    post-activate {
        # Copy the example configuration into place if there doesn't currently
        # exist a config file.
        if {![file exists ${cb_config_file}]} {
            copy ${cb_config_src} ${cb_config_file}
        }

        # Create the log file if it doesn't exist already
        if {![file exists ${cb_log_file}]} {
            system -W ${prefix} "touch ${cb_log_file}"
            file attributes ${cb_log_file} -owner ${cb_user} -group ${cb_user}
        }
    }

    notes "
        To start the ${name} service, use `port load`: $ sudo port load ${name}

        To stop the same, use `port unload`: $ sudo port unload ${name}

        The configuration file is located at: ${cb_config_file}

        When running as a service, the log can be found at: ${cb_log_file}
    "
}
